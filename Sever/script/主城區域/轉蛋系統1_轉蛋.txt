//===== rAthena Script ======================================= 
//= 轉蛋函數
//===== By: ================================================== 
//= Wayne
//===== Current Version: ===================================== 
//= 1.0
//===== Description: ========================================= 
//= 可設計轉蛋物品，並決定保底物品及需開啟次數
//===== Additional Comments: ================================= 
//= 1.0 First version. [Wayne]
//============================================================ 
// === 天波工作組 (https://www.angeling-studio.com/)
//============================================================
//
// 使用方法：callfunc "F_Gashapon", item_id;
// 使用範例：14296,Angel_Scroll,天使轉蛋,2,20,,10,,,,,0xFFFFFFFF,63,2,,,,,,{ callfunc "F_Gashapon", 14296; },{},{}
//
function	script	F_Gashapon2	{
	// .@DEBUG_FLAG 	: 如果設為 1，則 map-server 視窗會輸出轉蛋的機率及對應物品列表，
	// 						用於設計完一個新轉蛋後做檢查確認用。
	// .@announce_rate 	: 開到的物品，若低於設定機率，則會進行全伺服器廣播，採用萬分表(10000=100%)
	//						若不要有廣播設定，請將此設為 0 
	.@DEBUG_FLAG = 1;
	.@announce_rate = 100;
	
	.@egg_item = getarg(0);
	switch(.@egg_item) {
	/*
		setarray .@fun_name$[0]	: 轉蛋機率與物品列表，例如：
		
			setarray .@fun_name$[0], "10,501,10","500,502,6","2000,504,4","10000,506,2,507,2";		
			第一個值 "10,501,1" : 有 0.1 %的機率取得 501 道具1個
			第二個值 "500,502,6" : 有 5% 的機率獲得 502 道具6個
			第二個值 "2000,504,4" : 有 20% 的機率獲得 504 道具4個
			第三個值 "10000,506,2,507,2" : 若機率落在 > 20% 的機率以外則獲得 506 道具2個 或 507 道具2個 

			備註 :
			1. 機率填寫必須由小到大
			2. 最後一個機率一定要是 10000 (萬分率)
			
		.@guarantee_item		: 保底物品的物品編號
		.@guarantee_need_times 	: 開中保底物品，需要的開啟次數
			
			備註 :
			1. 若無保底設定，不要設定這兩個變數即可
	
	*/
	case 920001:	// 帝國轉蛋
		setarray .@fun_name$[0],"100,400054,1,18823,1,19299,1,28536,1,100295,1,910134,1,910135,1,100572,1,100596,1",
								"750,28437,1,18528,1,32259,1,28595,1,18853,1,28953,1,19353,1,400044,1,32237,1,2202,1,31479,1,31482,1,31618,1,31432,1,31573,1,410029,1,31814,1,6238,1,6239,1,22829,1,6909,1,23806,1,23538,1,24168,1,24169,1,24345,1,24346,1,24423,1,24424,1,24166,1,24167,1,24373,1,24374,1,24432,1,24433,1",
								"1300,31258,1,31792,1,31565,1,31382,1,31451,1,31476,1,100411,1,100229,1,1000337,1,6228,1,6232,1,6909,1",
								"1900,6909,1,25375,1,7925,1,100008,2,22820,2,22821,2,100007,2,100232,2,100233,2,100006,2",
								"2500,14608,2,12419,20,12418,20,14766,2,12596,2,12805,2,23044,2,22819,2",
								"10000,12429,20,12430,20,12431,20,12432,20,12433,20,12434,20,12436,20,12103,3,12794,1";
		setarray .@itemSSS[0],400054,18823,19299,28536,100295,910134,910135;
		.@guarantee_item = .@itemSSS[rand(0,6)];
		.@guarantee_need_times = 151;
		break;
	case 920002:	// 王牌轉蛋
		setarray .@fun_name$[0],"100,450135,1,400021,1,19308,1,19306,1,100295,1,910134,1,910135,1,23247,1",
								"750,18950,1,19249,1,5874,1,28901,1,28430,1,28567,1,400083,1,400085,1,28595,1,2979,1,31943,1,31121,1,31315,1,31619,1,31622,1,31588,1,31542,1,6238,1,6239,1,22829,1,6909,1,23806,1,23538,1,24035,1,24039,1,24044,1,24036,1,24037,1,24040,1",
								"1300,31565,1,31607,1,31621,1,31455,1,31463,1,31055,1,100411,1,100229,1,1000337,1,6228,1,6232,1,6909,1",
								"1900,6909,1,25375,1,7925,1,100008,2,22820,2,22821,2,100007,2,100232,2,100233,2,100006,2",
								"2500,14608,2,12419,20,12418,20,14766,2,12596,2,12805,2,23044,2,22819,2",
								"10000,12429,20,12430,20,12431,20,12432,20,12433,20,12434,20,12436,20,12103,3,12794,1";
		setarray .@itemSSS[0],450135,400021,19308,19306,100295,910134,910135;
		.@guarantee_item = .@itemSSS[rand(0,6)];
		.@guarantee_need_times = 151;
		break;
	case 920005:	// 天使轉蛋
		setarray .@fun_name$[0],"100,15361,1,15362,1,15363,1,15364,1,15365,1,15366,1,1001413,1",
								"750,28437,1,18528,1,32259,1,28595,1,18853,1,28953,1,19353,1,400044,1,32237,1,2202,1,31479,1,31482,1,31618,1,31432,1,31573,1,410029,1,31814,1,6238,1,6239,1,22829,1,6909,1,23806,1,23538,1,15430,1,15431,1,15432,1,15433,1",
								"1300,31565,1,31607,1,31621,1,31455,1,31463,1,31055,1,100411,1,100229,1,1000337,1,6228,1,6232,1,6909,1",
								"1900,6909,1,25375,1,7925,1,100008,2,22820,2,22821,2,100007,2,100232,2,100233,2,100006,2",
								"2500,14608,2,12419,20,12418,20,14766,2,12596,2,12805,2,23044,2,22819,2",
								"10000,12429,20,12430,20,12431,20,12432,20,12433,20,12434,20,12436,20,12103,3,12794,1";
		setarray .@itemSSS[0],15361,15362,15363,15364,15365,15366;
		.@guarantee_item = .@itemSSS[rand(0,5)];
		.@guarantee_need_times = 151;
		break;
	case 920010:	// 星願轉蛋
		setarray .@fun_name$[0],"100,4352,1,27287,1,4534,1,6909,50,400401,1,20502,1,480136,1,100620,1,100621,1",
								"750,18912,1,470029,1,19112,1,19097,1,15166,1,32270,1,19246,1,2576,1,2589,1,31047,1,31177,1,31203,1,20435,1,31176,1,31816,1,31849,1,6238,1,6239,1,23248,1,24084,1,24085,1,24086,1,24087,1,24088,1,24089,1,24669,1,24670,1,24671,1,24672,1,24673,1,24674,1",
								"1300,20267,1,20316,1,21206,1,420026,1,31674,1,31299,1,100411,1,100229,1,1000337,1,6228,1,6232,1,6909,1",
								"1900,6909,1,25375,1,7925,1,100008,2,22820,2,22821,2,100007,2,100232,2,100233,2,100006,2",
								"2500,14608,2,12419,20,12418,20,14766,2,12596,2,12805,2,23044,2,22819,2",
								"10000,12429,20,12430,20,12431,20,12432,20,12433,20,12434,20,12436,20,12103,3,12794,1";
		setarray .@itemSSS[0],4352,27287,4534,6909,400401,20502,480136;
		.@guarantee_item = .@itemSSS[rand(0,6)];
		.@guarantee_need_times = 151;
		break;
	case 14297:	// 惡魔轉蛋
		setarray .@fun_name$[0],"50,607,10","200,608,10","2200,504,50","10000,501,15,502,10";
		.@guarantee_item = 607;
		.@guarantee_need_times = 151;
		break;	
	case 60978:	// 忘卻
		setarray .@fun_name$[0],"1,27119,1,4305,1",
								"5,20963,1,20965,1,20967,1,22829,1",
								"250,6238,1,6239,1,9551,3",
								"4000,6241,3,6240,3,616,1,6226,2,6225,2",
								"5000,17507,5,16770,1",
								"10000,12922,1,12912,1,12202,10,12204,10,12206,10,12919,1,608,10";
		.@guarantee_item = 4305;
		.@guarantee_need_times = 151;
		.@announce_rate = 250;
		break;
	case 60979:	// 驚駭
		setarray .@fun_name$[0],"1,4649,1,27164,1",
								"5,20964,1,20966,1,20968,1,22829,1",
								"250,6238,1,6239,1,9551,3",
								"4000,6241,3,6240,3,616,1,6226,2,6225,2",
								"5000,17507,5,16770,1",
								"10000,12922,1,12912,1,12203,10,12205,10,12207,10,12919,1,607,4";
	case 61030:	// 萌新轉蛋
		setarray .@fun_name$[0],"10,4494,1",
		                        "60,2566,1,2856,1,2857,1,15023,1",
		                        "1000,20737,1,20746,1,5914,1,5584,1,18599,1,5495,,18858,1",
								"10000,14533,1,14996,1,23043,1,6484,1,616,1,12900,1,13607,5,12913,1,12903,1,12904,1,12905,1,12906,1,12907,1,12908,1,16770,1,6423,3,12914,1,12922,1,12919,1,23630,1,12901,1";
		//.@guarantee_item = 13549;
		//.@guarantee_need_times = 1;
		break;	
	}
SrollStart:
	if ( getstatus(SC_COLD_FORCE_OPTION,0) == 1 ){
	.@check_index = 0;
	for(.@i=0; .@fun_name$[.@i]!=""; .@i++) {
		deletearray .@array$;
		explode(.@array$,.@fun_name$[.@i],",");
				
		.@rate[.@i] = atoi(.@array$[0]);
		for(.@j=1; .@j<getarraysize(.@array$); .@j+=2) {		
			setd ".@item_"+.@i+"["+(.@j/2)+"]",atoi(.@array$[.@j]);
			setd ".@num_"+.@i+"["+(.@j/2)+"]",atoi(.@array$[.@j+1]);
			if(.@guarantee_item == atoi(.@array$[.@j]))
				.@check_index++;
		}		
		
		//if(.@DEBUG_FLAG) {
		//	debugmes "機率 : "+.@rate[.@i];
		//	for(.@j=0; .@j<getarraysize(getd(".@item_"+.@i)); .@j++) {
		//		debugmes ".@item : " + getitemname(getd(".@item_"+.@i+"["+.@j+"]")) + " x " + getd(".@num_"+.@i+"["+.@j+"]");
		//	}
		//}
	}
	
	/*if(!.@check_index) {
	debugmes "[轉蛋系統]"+getitemname(.@egg_item)+"(ID:"+.@egg_item+")的保底物品並沒有出現在轉蛋可獲得的列表中。";
	debugmes "[轉蛋系統]請再次檢查設定。";
	}*/	
	
	set .@rand,rand(1,10000);
	for(.@k=0; .@k<getarraysize(.@rate); .@k++) {
		if(.@rand <= .@rate[.@k]) {
			.@rand_item = rand(getarraysize(getd(".@item_"+.@k)));
			set .@return_item_id, getd(".@item_"+.@k+"["+.@rand_item+"]");
			set .@return_item_amount, getd(".@num_"+.@k+"["+.@rand_item+"]");
			setd "egg_"+.@egg_item+"_times", getd("egg_"+.@egg_item+"_times")+1;
			break;
		}
	}
	
	// check guarantee item
	if(.@guarantee_item == .@return_item_id)
		setd "egg_"+.@egg_item+"_times", 0;
	else if(.@guarantee_item) {
		.@open_times = getd("egg_"+.@egg_item+"_times");
		if(.@open_times >= .@guarantee_need_times) {
			for(.@k=0; .@k<getarraysize(.@rate); .@k++) {
				.@index = inarray(getd(".@item_"+.@k),.@guarantee_item);
				if(.@index >= 0)
					break;
			}			
			.@return_item_id = .@guarantee_item;
			.@return_item_amount = getd(".@num_"+.@k+"["+.@index+"]");
			setd "egg_"+.@egg_item+"_times", 0;
			
		}
				if ( .@open_times < 151 ){
				//dispbottom "[系統]當前幸運值為: "+.@open_times+"　(幸運值達到150時，下次必定SSS)",0xFF0000;
				}
				if ( .@open_times == 150 ){
				dispbottom "[系統]當前幸運值為: "+.@open_times+"　(下次必定SSS)",0xFF0000;
				}
	}
		
	if(.@announce_rate && .@rate[.@k] <= .@announce_rate){
		if (.@rate[.@k] <= 100 ){
			announce "恭喜玩家「"+strcharinfo(0)+"」使用"+getitemname(.@egg_item)+"開到了"+.@return_item_amount+"個"+getitemname(.@return_item_id)+"。",bc_all; 
			setd "egg_"+.@egg_item+"_times", 0;
		}else{
			announce "恭喜玩家「"+strcharinfo(0)+"」使用"+getitemname(.@egg_item)+"開到了"+.@return_item_amount+"個"+getitemname(.@return_item_id)+"。",bc_all; 
		}	
	}
	getitem .@return_item_id,.@return_item_amount;
	return .@return_item_id;
	}else{
	setd "egg_"+.@egg_item+"_times", 0;
	bonus_script "{sc_start SC_COLD_FORCE_OPTION,3600000,1;}",3600,1,0,844;}
	goto SrollStart;
}